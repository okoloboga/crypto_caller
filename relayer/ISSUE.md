# Relayer Service - –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–±–ª–µ–º –∏ —Ä–µ—à–µ–Ω–∏–π

## –ó–∞–¥–∞—á–∞

Relayer –ø–æ–ª—É—á–∞–µ—Ç TON –æ—Ç –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ –∏ –¥–æ–ª–∂–µ–Ω:
1. –û–±–º–µ–Ω—è—Ç—å TON –Ω–∞ jetton —á–µ—Ä–µ–∑ STON.fi
2. –°–∂–µ—á—å jetton'—ã –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å callback –∫–æ–Ω—Ç—Ä–∞–∫—Ç—É
3. –ü—Ä–∏ –æ—à–∏–±–∫–µ - –≤–µ—Ä–Ω—É—Ç—å TON –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (refund)


## ‚úÖ –†–ï–®–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

### ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ ‚Ññ1: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç –∫—É—Ä—Å–∞ –æ–±–º–µ–Ω–∞ (–†–ï–®–ï–ù–û 2025-10-10)

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ –≤ —Ä–µ–∑–µ—Ä–≤–∞—Ö –ø—É–ª–∞
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ñ–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á–µ—Ç–∞: `rate = (jettonReserve * 10^9 * 95) / (tonReserve * 100)`
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ 0 –∏ —Ä–∞–∑—É–º–Ω–æ—Å—Ç—å)
- –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ö—É—Ä—Å —Ç–µ–ø–µ—Ä—å —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ: `1 TON = 8984 nano-jettons`

---

### ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ ‚Ññ2: Router v1/v2 –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å (–†–ï–®–ï–ù–û 2025-10-10)

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

**–†–µ—à–µ–Ω–∏–µ:**
- –ò–∑–º–µ–Ω–µ–Ω Router —Å v1 –Ω–∞ v2.2 (–∞–¥—Ä–µ—Å: EQCS4UEa5UaJLzOyyKieqQOQ2P9M-7kXpkO5HnP3Bv250cN3)
- –ò–∑–º–µ–Ω–µ–Ω pTON —Å v1 –Ω–∞ v2.1 –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω minAskAmount: –æ—Å—Ç–∞–µ—Ç—Å—è bigint –¥–ª—è Router v2.2

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Router v2.2 –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ, swapTxParams —Å–æ–∑–¥–∞–µ—Ç—Å—è

---

### üîÑ –ü—Ä–æ–±–ª–µ–º–∞ ‚Ññ3: gasAmount vs value –≤ Router v2.2 (–í –ü–†–û–¶–ï–°–°–ï 2025-10-10)

**–°—Ç–∞—Ç—É—Å:** üîÑ –ò–°–ü–†–ê–í–õ–Ø–ï–¢–°–Ø

**–ü—Ä–æ–±–ª–µ–º–∞:** Router v2.2 –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `value` –≤–º–µ—Å—Ç–æ `gasAmount` –≤ swapTxParams

**–õ–æ–≥ –æ—à–∏–±–∫–∏:**
```
"allKeys": ["to", "value", "body"]
"hasAmount": false
"hasTonAmount": false  
"hasValue": true
```

**–†–µ—à–µ–Ω–∏–µ:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `swapTxParams.value` –≤–º–µ—Å—Ç–æ `swapTxParams.gasAmount`
- –î–æ–±–∞–≤–ª–µ–Ω fallback: `swapTxParams.value || swapTxParams.gasAmount`

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** `BigInt(swapTxParams.value)` –≤–º–µ—Å—Ç–æ `BigInt(undefined)`

---

## üîç –ê–†–•–ò–í: –°—Ç–∞—Ä—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–±–ª–µ–º–∞ ‚Ññ1: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç –∫—É—Ä—Å–∞ –æ–±–º–µ–Ω–∞

**–õ–æ–≥ –æ—à–∏–±–∫–∏:**
```
LOG [SwapService] [DEBUG] Current swap rate: 1 TON = 0 jettons
LOG [SwapService] [DEBUG] Swap transaction built: to=..., amount=undefined
ERROR [SwapService] [DEBUG] STON.fi swap failed: Cannot convert undefined to a BigInt
```

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç –∫—É—Ä—Å–∞ –æ–±–º–µ–Ω–∞ –≤ `getSwapRate()`.

**–ê–Ω–∞–ª–∏–∑ —Ä–µ–∑–µ—Ä–≤–æ–≤:**
- **reserve0: 22576656310132521** (–æ—á–µ–Ω—å –±–æ–ª—å—à–æ–µ —á–∏—Å–ª–æ)
- **reserve1: 213513654822** (–º–µ–Ω—å—à–µ–µ —á–∏—Å–ª–æ)
- **–¢–µ–∫—É—â–∏–π —Ä–∞—Å—á–µ—Ç:** `rate = (jettonReserve * 95n) / (tonReserve * 100n) = 0`

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
1. –†–µ–∑–µ—Ä–≤—ã –ø–æ–º–µ–Ω—è–Ω—ã –º–µ—Å—Ç–∞–º–∏ (reserve0 = jetton, reserve1 = TON)
2. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á–µ—Ç–∞ –∫—É—Ä—Å–∞
3. –ü—Ä–æ–±–ª–µ–º–∞ —Å –µ–¥–∏–Ω–∏—Ü–∞–º–∏ –∏–∑–º–µ—Ä–µ–Ω–∏—è (–Ω–∞–Ω–æ-–µ–¥–∏–Ω–∏—Ü—ã)

**–û–±–Ω–∞—Ä—É–∂–µ–Ω –∞–∫—Ç–∏–≤–Ω—ã–π –ø—É–ª RUBLE-pTON:**
- **–ê–¥—Ä–µ—Å –ø—É–ª–∞:** [EQCJKn-99vd6GEUKTkVEyFwmha33lxtb2oo-eMsU0tFGIZbf](https://tonviewer.com/EQCJKn-99vd6GEUKTkVEyFwmha33lxtb2oo-eMsU0tFGIZbf)
- **–¢–∏–ø:** `jetton_master, stonfi_pool_v2` ‚úÖ
- **–°—Ç–∞—Ç—É—Å:** `Active` ‚úÖ
- **–ü–∞—Ä–∞:** `RUBLE-pTON` ‚úÖ
- **–õ–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å:** `Max.supply: 69,047.09 RUBLE-pTON LP`
- **–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:** 01 Oct, 30 Sep, 22 Sep (–∞–∫—Ç–∏–≤–µ–Ω!)

## üéØ –¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –ó–ê–î–ê–ù–ò–ï –ü–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Æ

### –ó–∞–¥–∞—á–∞ 1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å ABI/–≤–µ—Ä—Å–∏—é mismatch

**–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑—É–µ–º V1 SDK –¥–ª—è V2 –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞.

**–†–µ—à–µ–Ω–∏–µ (–ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É):**

#### 1.1 –°–ê–ú–û–ï –ü–†–û–°–¢–û–ï - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å router.getPool()
```typescript
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û:
const poolAddress = await this.router.getPoolAddress({...});
const pool = this.client.open(DEX.v1.Pool.create(Address.parse(poolAddress.toString())));

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:
const pool = await this.router.getPool([ptonAddress, jettonAddress]);
const poolData = await pool.getPoolData(); // –î–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å!
```

#### 1.2 –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ê - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å DEX.v2.Pool
```typescript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - V2 SDK –¥–ª—è V2 –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞
const pool = this.client.open(DEX.v2.Pool.create(Address.parse(poolAddress.toString())));
const poolData = await pool.getPoolData();
```

#### 1.3 –û–ë–ù–û–í–ò–¢–¨ SDK
```bash
npm update @ston-fi/sdk
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ DEX.v2 –¥–æ—Å—Ç—É–ø–µ–Ω
```

### –ó–∞–¥–∞—á–∞ 2: –ò—Å–ø—Ä–∞–≤–∏—Ç—å amount=undefined

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è pool data –Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏, –æ—Ç–∫—É–¥–∞ –±–µ—Ä–µ—Ç—Å—è `undefined` –≤ amount.

**–†–µ—à–µ–Ω–∏–µ:**
1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å pool data (–ó–∞–¥–∞—á–∞ 1)
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `getSwapRate()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
3. –ù–∞–π—Ç–∏ –º–µ—Å—Ç–æ, –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `undefined` –≤–º–µ—Å—Ç–æ rate

### –ó–∞–¥–∞—á–∞ 3: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ –ø—É–ª–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** Router –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å –ø—É–ª–∞.

**–†–µ—à–µ–Ω–∏–µ:**
1. **–ë—ã—Å—Ç—Ä—ã–π fix:** –•–∞—Ä–¥–∫–æ–¥ —Ä–∞–±–æ—á–µ–≥–æ –∞–¥—Ä–µ—Å–∞
```typescript
const poolAddress = Address.parse("EQCJKn-99vd6GEUKTkVEyFwmha33lxtb2oo-eMsU0tFGIZbf");
```

2. **–ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `router.getPool()` –≤–º–µ—Å—Ç–æ `getPoolAddress()`

## üìã –ü–õ–ê–ù –í–´–ü–û–õ–ù–ï–ù–ò–Ø

### –≠—Ç–∞–ø 1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å ABI mismatch (–ü–†–ò–û–†–ò–¢–ï–¢ 1)
1. –ó–∞–º–µ–Ω–∏—Ç—å `getPoolAddress` + `DEX.v1.Pool.create()` –Ω–∞ `router.getPool()`
2. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å - –¥–æ–ª–∂–Ω—ã –∏—Å—á–µ–∑–Ω—É—Ç—å `exit_code: -13`
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `pool.getPoolData()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ

### –≠—Ç–∞–ø 2: –ò—Å–ø—Ä–∞–≤–∏—Ç—å amount=undefined (–ü–†–ò–û–†–ò–¢–ï–¢ 2)
1. –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è pool data –ø—Ä–æ–≤–µ—Ä–∏—Ç—å `getSwapRate()`
2. –ù–∞–π—Ç–∏ –º–µ—Å—Ç–æ, –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `undefined` –≤ amount
3. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø–µ—Ä–µ–¥–∞—á—É –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è

### –≠—Ç–∞–ø 3: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ –ø—É–ª–∞ (–ü–†–ò–û–†–ò–¢–ï–¢ 3)
1. –ï—Å–ª–∏ `router.getPool()` –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ö–∞—Ä–¥–∫–æ–¥
2. –í –±—É–¥—É—â–µ–º —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è, –ø–æ—á–µ–º—É router –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å

## üéØ –û–ñ–ò–î–ê–ï–ú–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
- ‚úÖ `pool.getPoolData()` –≤–µ—Ä–Ω–µ—Ç –¥–∞–Ω–Ω—ã–µ –±–µ–∑ `exit_code: -13`
- ‚úÖ `poolData.reserve0` –∏ `poolData.reserve1` –±—É–¥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ä–µ–∑–µ—Ä–≤—ã
- ‚úÖ `getSwapRate()` –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ `amount=undefined` –∏—Å—á–µ–∑–Ω–µ—Ç
- ‚úÖ Swap —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –±—É–¥–µ—Ç —Å—Ç—Ä–æ–∏—Ç—å—Å—è —É—Å–ø–µ—à–Ω–æ

## –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç ChatGPT:

---

## üí• –ü—Ä–æ–±–ª–µ–º–∞ –≤ —Ñ–æ—Ä–º—É–ª–µ

–¢—ã —Å–µ–π—á–∞—Å —Å—á–∏—Ç–∞–µ—à—å –∫—É—Ä—Å —Ç–∞–∫:

```ts
const rate = (jettonReserve * 95n) / (tonReserve * 100n);
```

–ø—Ä–∏ —ç—Ç–æ–º `reserve0` –∏ `reserve1` —É —Ç–µ–±—è ‚Äî **–≤ –Ω–∞–Ω–æ—Ç–æ–Ω–∞—Ö –∏ –Ω–∞–Ω–æ–¥–∂–µ—Ç—Ç–æ–Ω–∞—Ö** (–æ–±–∞ –∏–º–µ—é—Ç 9 –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π).
–ï—Å–ª–∏ `reserve0 ‚âà 22 576 656 310 132 521` –∏ `reserve1 ‚âà 213 513 654 822`,
—Ç–æ —á–∏—Å–ª–µ–Ω–Ω–æ —ç—Ç–æ:

```text
22 576 656 310 132 521 nanotons = 22 576 TON
213 513 654 822 nanoRUBLE = 213 RUBLE
```

–¢.–µ. **1 TON ‚âà 0.0095 RUBLE**, –∞ –Ω–µ 106 000 üòÖ
–ó–Ω–∞—á–∏—Ç, —Ç—ã –ø—Ä–æ—Å—Ç–æ **–ø–µ—Ä–µ–ø—É—Ç–∞–ª –ø–æ—Ä—è–¥–æ–∫ —Ä–µ–∑–µ—Ä–≤–æ–≤** (STON.fi —Ö—Ä–∞–Ω–∏—Ç –∏—Ö –∫–∞–∫ `[token0, token1]` –≤ –ø–æ—Ä—è–¥–∫–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –ø—É–ª).

---

## ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞

STON.fi –≤—Å–µ–≥–¥–∞ —Å—á–∏—Ç–∞–µ—Ç `reserve0` ‚Üî `token0`, `reserve1` ‚Üî `token1`.
–¢–≤–æ–π –ø—É–ª ‚Äî **Jetton (RUBLE)** –ø—Ä–æ—Ç–∏–≤ **pTON**,
–∏ –≤ –±–ª–æ–∫—á–µ–π–Ω–µ –æ–Ω —Ö—Ä–∞–Ω–∏—Ç—Å—è, —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –∫–∞–∫ **(RUBLE, pTON)**, –Ω–µ –Ω–∞–æ–±–æ—Ä–æ—Ç.

–¢–æ –µ—Å—Ç—å, –Ω—É–∂–Ω–æ –¥–µ–ª–∏—Ç—å –Ω–∞–æ–±–æ—Ä–æ—Ç:

```ts
// rate = —Å–∫–æ–ª—å–∫–æ jettons –∑–∞ 1 TON
const rate = (jettonReserve * 10n ** 9n * 95n) / (tonReserve * 100n);
```

–∏–ª–∏ –µ—Å–ª–∏ —Ä–µ–∑–µ—Ä–≤0 = jetton, —Ä–µ–∑–µ—Ä–≤1 = TON, —Ç–æ –Ω–∞–æ–±–æ—Ä–æ—Ç:

```ts
const rate = (reserve0 * 10n ** 9n * 95n) / (reserve1 * 100n);
```

---

## üßÆ –ü—Ä–∏–º–µ—Ä –ø—Ä–æ–≤–µ—Ä–∫–∏

–í–æ–∑—å–º—ë–º —Ç–≤–æ–∏ —Ä–µ–∞–ª—å–Ω—ã–µ —Ü–∏—Ñ—Ä—ã:

```ts
const tonReserve = 22576656310132521n; // 22 576 TON
const jettonReserve = 213513654822n;   // 213 RUBLE
const rate = (jettonReserve * 10n ** 9n) / tonReserve;
console.log(rate); // ‚âà 9456 nanoRUBLE –∑–∞ 1 nanoTON
```

‚Üí `rate ‚âà 9456`, —Ç–æ –µ—Å—Ç—å **1 TON ‚âà 9 456 000 000 RUBLE**, –µ—Å–ª–∏ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –∏–∑ nano –≤ –æ–±—ã—á–Ω—ã–µ –µ–¥–∏–Ω–∏—Ü—ã ‚âà 9.45 RUBLE** ‚Äî —Ä–∞–∑—É–º–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.
(–ï—Å–ª–∏ –Ω–∞–æ–±–æ—Ä–æ—Ç ‚Äî —Ç–æ–≥–¥–∞ –±—É–¥–µ—Ç 0.0001 RUBLE –∑–∞ 1 TON, —á—Ç–æ —è–≤–Ω–æ –Ω–µ —Ç–∞–∫.)

---

## üß© –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ `getSwapRate`

–í–æ—Ç —Ç–∞–∫ –±—É–¥–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ:

```ts
// Get pool data
const poolData = await pool.getPoolData();
const reserve0 = poolData.reserve0;
const reserve1 = poolData.reserve1;

// –û–ø—Ä–µ–¥–µ–ª–∏ –ø–æ—Ä—è–¥–æ–∫ —Ç–æ–∫–µ–Ω–æ–≤
// STON.fi SDK v2_1 –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª—è token0 –∏ token1 ‚Äî –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:
const token0 = await pool.getToken0();
const token1 = await pool.getToken1();

this.logger.debug(`[DEBUG] token0=${token0.toString()}, token1=${token1.toString()}`);

let tonReserve: bigint;
let jettonReserve: bigint;

// –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –≥–¥–µ TON/pTON
if (token0.toString() === ptonAddress.toString()) {
  tonReserve = reserve0;
  jettonReserve = reserve1;
} else {
  tonReserve = reserve1;
  jettonReserve = reserve0;
}

// –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Å—à—Ç–∞–± –∏ —Å–ª–∏–ø–ø–µ–¥–∂
const rate = (jettonReserve * 10n ** 9n * 95n) / (tonReserve * 100n);
this.logger.log(`[DEBUG] Corrected swap rate: 1 TON = ${rate.toString()} jettons`);
return rate;
```

---

## üí° –ü–æ—á–µ–º—É —Ä–∞–Ω—å—à–µ –±—ã–ª–æ ‚Äú1 TON = 0 jettons‚Äù

–ü–æ—Ç–æ–º—É —á—Ç–æ `(reserve1 * 95n) / (reserve0 * 100n)` –ø—Ä–∏ —Ç–∞–∫–∏—Ö —á–∏—Å–ª–∞—Ö –¥–∞–≤–∞–ª–æ –º–µ–Ω—å—à–µ 1 ‚Üí –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –≤ BigInt –¥–∞–ª–æ 0.
–ê –¥–∞–ª–µ–µ `(amountNanotons * rate)` ‚Üí 0, –∏ –≤ –º–æ–º–µ–Ω—Ç `BigInt(undefined)` ‚Äî –≤—ã–±—Ä–æ—Å –æ—à–∏–±–∫–∏.

---

## üîß –†–µ–∑—é–º–µ –ø—Ä–∞–≤–æ–∫

1. –í `getSwapRate()`:

   * –û–ø—Ä–µ–¥–µ–ª–∏, –≥–¥–µ TON/pTON, –∞ –≥–¥–µ Jetton, —á–µ—Ä–µ–∑ `getToken0() / getToken1()`.
   * –ü–µ—Ä–µ—Å—á–∏—Ç–∞–π —Ñ–æ—Ä–º—É–ª—É, –¥–æ–±–∞–≤–∏–≤ –º–Ω–æ–∂–∏—Ç–µ–ª—å `10^9` –∏ –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ—Ä—è–¥–∫–∞.
2. –í `performSwap()` –æ—Å—Ç–∞–≤—å `(amountNanotons * rate) / 1_000_000_000n` ‚Äî —Ç–µ–ø–µ—Ä—å `rate` –±—É–¥–µ—Ç –≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –µ–¥–∏–Ω–∏—Ü–∞—Ö.
3. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —Ç–≤–æ–π –∫—É—Ä—Å `‚âà 106 000 RUBLE –∑–∞ TON` —Å—Ç–∞–Ω–µ—Ç —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å —Ç–µ–º, —á—Ç–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç STON.fi UI.
