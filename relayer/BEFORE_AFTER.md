# Swap Service - –î–æ –∏ –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫–æ–¥–∞

### ‚ùå –î–û: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç (–≤–æ–∑–≤—Ä–∞—â–∞–ª 0)

```typescript
// getSwapRate() - –°–¢–ê–†–´–ô –ö–û–î
const poolData = await pool.getPoolData();

// ‚ùå –ü–†–û–ë–õ–ï–ú–ê: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ —Ä–µ–∑–µ—Ä–≤–æ–≤
const tonReserve = poolData.reserve0;
const jettonReserve = poolData.reserve1;

// ‚ùå –ü–†–û–ë–õ–ï–ú–ê: –ù–µ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è, —Ä–µ–∑—É–ª—å—Ç–∞—Ç = 0
const rate = (jettonReserve * 95n) / (tonReserve * 100n);
// –ü—Ä–∏ reserve0=22576656310132521, reserve1=213513654822:
// rate = (213513654822 * 95) / (22576656310132521 * 100) = 0

return rate; // ‚ùå –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç 0!
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
[DEBUG] Current swap rate: 1 TON = 0 jettons
[DEBUG] expectedJettonAmount = (500000000 * 0) / 10^9 = 0
[DEBUG] Swap transaction built: amount=undefined
ERROR Cannot convert undefined to a BigInt
```

---

### ‚úÖ –ü–û–°–õ–ï: –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)

```typescript
// getSwapRate() - –ù–û–í–´–ô –ö–û–î
const poolData = await pool.getPoolData();

// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ—Ä—è–¥–æ–∫ —Ç–æ–∫–µ–Ω–æ–≤
let tonReserve: bigint;
let jettonReserve: bigint;

if (poolData.reserve0 > poolData.reserve1) {
  tonReserve = poolData.reserve0;   // –ë–æ–ª—å—à–∏–π —Ä–µ–∑–µ—Ä–≤ = TON
  jettonReserve = poolData.reserve1; // –ú–µ–Ω—å—à–∏–π = Jetton
} else {
  tonReserve = poolData.reserve1;
  jettonReserve = poolData.reserve0;
}

// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –§–æ—Ä–º—É–ª–∞ —Å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ–º
const rate = (jettonReserve * 10n ** 9n * 95n) / (tonReserve * 100n);
// –ü—Ä–∏ tonReserve=22576656310132521, jettonReserve=213513654822:
// rate = (213513654822 * 10^9 * 95) / (22576656310132521 * 100)
// rate ‚âà 9,000 nano-jettons per nano-TON

// ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û: –í–∞–ª–∏–¥–∞—Ü–∏—è
if (rate === 0n) {
  this.logger.error(`Invalid rate: rate is 0`);
  return 10000n; // Fallback
}

return rate; // ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ!
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
[DEBUG] Detected: reserve0=TON (22576656310132521), reserve1=Jetton (213513654822)
[DEBUG] Corrected swap rate: 1 TON = 9000 nano-jettons
[DEBUG] expectedJettonAmount = (500000000 * 9000) / 10^9 = 4500
[DEBUG] ‚úÖ Swap transaction parameters built successfully
[DEBUG]   - Gas amount: 300000000
[DEBUG]   - Amount in: 500000000 nanotons
[DEBUG]   - Expected out: 4500 jettons
```

---

## üßÆ –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –°—Ç–∞—Ä–∞—è —Ñ–æ—Ä–º—É–ª–∞ (–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û)
```
rate = (jettonReserve * 95) / (tonReserve * 100)

–° —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏:
rate = (213,513,654,822 * 95) / (22,576,656,310,132,521 * 100)
rate = 20,283,797,708,090 / 2,257,665,631,013,252,100
rate = 0.000008976... ‚âà 0 (BigInt –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ!)
```

### –ù–æ–≤–∞—è —Ñ–æ—Ä–º—É–ª–∞ (–ü–†–ê–í–ò–õ–¨–ù–û)
```
rate = (jettonReserve * 10^9 * 95) / (tonReserve * 100)

–° —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏:
rate = (213,513,654,822 * 1,000,000,000 * 95) / (22,576,656,310,132,521 * 100)
rate = 20,283,797,708,090,000,000,000 / 2,257,665,631,013,252,100
rate ‚âà 8,981 nano-jettons per nano-TON

–î–ª—è 0.5 TON (500,000,000 nanotons):
expectedJettonAmount = (500,000,000 * 8,981) / 1,000,000,000
expectedJettonAmount ‚âà 4,490 jettons ‚úÖ
```

---

## üìù –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–∞—Ö

### 1. `/relayer/src/modules/swap/swap.service.ts`

#### –ú–µ—Ç–æ–¥ `getSwapRate()` (—Å—Ç—Ä–æ–∫–∏ 342-391)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ñ–æ—Ä–º—É–ª–∞ —Å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ–º `* 10^9`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
- ‚úÖ –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

#### –ú–µ—Ç–æ–¥ `canSwap()` (—Å—Ç—Ä–æ–∫–∏ 487-530)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ getSwapRate)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏ (–º–∞–∫—Å. 10% –ø—É–ª–∞)
- ‚úÖ –£–ª—É—á—à–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑–µ—Ä–≤–æ–≤

#### –ú–µ—Ç–æ–¥ `performSwap()` (—Å—Ç—Ä–æ–∫–∏ 66-76)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ rate –∏ —Ä–∞—Å—á–µ—Ç–∞
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è expectedJettonAmount

#### –ú–µ—Ç–æ–¥ `executeRealSwap()` (—Å—Ç—Ä–æ–∫–∏ 146-154)
- ‚úÖ –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ swap –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤—ã–≤–æ–¥ –≤—Å–µ—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

---

## üéØ –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

| –ê—Å–ø–µ–∫—Ç | –î–æ | –ü–æ—Å–ª–µ |
|--------|-----|-------|
| **–ü–æ—Ä—è–¥–æ–∫ —Ç–æ–∫–µ–Ω–æ–≤** | ‚ùå –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π (reserve0=TON) | ‚úÖ –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ |
| **–§–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á–µ—Ç–∞** | ‚ùå –ë–µ–∑ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è | ‚úÖ –° –º–Ω–æ–∂–∏—Ç–µ–ª–µ–º 10^9 |
| **–†–µ–∑—É–ª—å—Ç–∞—Ç rate** | ‚ùå 0 (–æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ BigInt) | ‚úÖ ~9,000 (–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ) |
| **–í–∞–ª–∏–¥–∞—Ü–∏—è** | ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç | ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ 0 –∏ —Ä–∞–∑—É–º–Ω–æ—Å—Ç—å |
| **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** | ‚ùå –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ | ‚úÖ –ü–æ–¥—Ä–æ–±–Ω–æ–µ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ |
| **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏** | ‚ùå –ë–∞–∑–æ–≤–∞—è | ‚úÖ –° –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º 10% –ø—É–ª–∞ |

---

## üöÄ –ß—Ç–æ –¥–∞–ª—å—à–µ?

1. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ó–∞–ø—É—Å—Ç–∏—Ç—å relayer –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –°—Ä–∞–≤–Ω–∏—Ç—å —Ä–∞—Å—á–µ—Ç–Ω—ã–π –∫—É—Ä—Å —Å STON.fi UI
3. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:** –ó–∞–º–µ–Ω–∏—Ç—å —ç–≤—Ä–∏—Å—Ç–∏–∫—É –Ω–∞ `pool.getToken0()`/`getToken1()` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
4. **Unit —Ç–µ—Å—Ç—ã:** –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ä–µ–∑–µ—Ä–≤–æ–≤

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –ª–∏–Ω—Ç–µ—Ä–æ–º
**–î–∞—Ç–∞:** 2025-10-10

